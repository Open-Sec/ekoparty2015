description = [[Search for exploits in the csv file from exploit-db.com]]
---
--@usage
-- nmap -sV -v <host> --script exploitdb,smb-check-vulns --script-args qchars=14
--
-- @args qchars OPTIONAL to search in the "banner" field (files.csv 3rd field) for less/more than 20 chars (default)

author = "wcu35745"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"safe", "vuln"}

local stdnse = require("stdnse")

portrule = function(host, port)
    return port.state == "open"
end

action = function(host, port)
    local qchars = 20
    if nmap.registry.args.qchars ~= nil then
        qchars = nmap.registry.args.qchars
    end

    local banner = string.sub(port.version.product,1,qchars)
    -- local version = port.version.version
    -- stdnse.print_debug(1,version)
    local exploits = ""
    for line in io.lines ("/local/copy/of/exploit-database-master/files.csv") do
         if string.match(line, banner) then
	     exploits = exploits..line.."\n"
         end
    end
    if not string.match(exploits, "\n") then
        exploits = ""
    end
    exploits = " \n"..exploits
    return exploits
end
